name: Manual Build

on:
  workflow_dispatch:
    inputs:
      build_portable:
        description: '构建便携版'
        type: boolean
        default: true
      build_msix:
        description: '构建 MSIX 安装包'
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # ========== 便携版 (Portable) ==========
      - name: Build Portable x64
        if: ${{ inputs.build_portable }}
        run: dotnet publish TermiusCN-Tool.csproj -c Release -r win-x64 -p:Platform=x64 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true --self-contained true -o publish/portable-x64

      - name: Build Portable ARM64
        if: ${{ inputs.build_portable }}
        run: dotnet publish TermiusCN-Tool.csproj -c Release -r win-arm64 -p:Platform=ARM64 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true --self-contained true -o publish/portable-arm64

      - name: Create Portable x64 Archive
        if: ${{ inputs.build_portable }}
        run: Compress-Archive -Path publish/portable-x64/* -DestinationPath TermiusCN-Tool-Portable-x64.zip

      - name: Create Portable ARM64 Archive
        if: ${{ inputs.build_portable }}
        run: Compress-Archive -Path publish/portable-arm64/* -DestinationPath TermiusCN-Tool-Portable-arm64.zip

      # ========== MSIX 安装包 ==========
      
      # 合并了解码和导入步骤，使用“存储区模式”避免 APPX0105 错误
      - name: Import Certificate & Build MSIX
        if: ${{ inputs.build_msix }}
        env:
          SIGNING_CERT_BASE64: ${{ secrets.SIGNING_CERTIFICATE }}
          SIGNING_PWD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        shell: pwsh
        run: |
          # 1. 检查 Secret
          if ([string]::IsNullOrWhiteSpace($env:SIGNING_CERT_BASE64)) {
            Write-Host "Error: Secret SIGNING_CERTIFICATE is empty." -ForegroundColor Red
            exit 1
          }

          # 2. 解码证书
          $pfxPath = "${{ github.workspace }}\SigningCertificate.pfx"
          $certBytes = [Convert]::FromBase64String("$env:SIGNING_CERT_BASE64")
          [IO.File]::WriteAllBytes($pfxPath, $certBytes)
          
          # 3. 【核心步骤】导入证书到当前用户存储区
          # 这样做比让 MSBuild 直接读文件要稳定得多
          Write-Host "Importing certificate to CurrentUser\My store..."
          $password = ConvertTo-SecureString -String "$env:SIGNING_PWD" -Force -AsPlainText
          
          try {
            $cert = Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $password
            $thumbprint = $cert.Thumbprint
            Write-Host "Success! Certificate Imported. Thumbprint: $thumbprint"
          } catch {
            Write-Error "Failed to import certificate. Password might be wrong or cert is invalid."
            exit 1
          }
          
          # 4. 构建 x64 (使用指纹签名)
          Write-Host "Building SIGNED MSIX for x64..."
          # 注意：PackageCertificateKeyFile 设为空，强制使用 Thumbprint
          msbuild TermiusCN-Tool.csproj /restore `
            /p:Configuration=Release /p:Platform=x64 /p:RuntimeIdentifier=win-x64 `
            /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=true `
            /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly `
            /p:AppxPackageDir="AppPackages\" `
            /p:PackageCertificateThumbprint="$thumbprint" `
            /p:PackageCertificateKeyFile="" `
            /p:PackageCertificatePassword=""

          # 5. 构建 ARM64 (使用同一指纹)
          Write-Host "Building SIGNED MSIX for ARM64..."
          msbuild TermiusCN-Tool.csproj /restore `
            /p:Configuration=Release /p:Platform=ARM64 /p:RuntimeIdentifier=win-arm64 `
            /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=true `
            /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly `
            /p:AppxPackageDir="AppPackages\" `
            /p:PackageCertificateThumbprint="$thumbprint" `
            /p:PackageCertificateKeyFile="" `
            /p:PackageCertificatePassword=""

      - name: Export public certificate (.cer)
        if: ${{ inputs.build_msix }}
        env:
          SIGNING_PWD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          if (Test-Path "${{ github.workspace }}\SigningCertificate.pfx") {
             $password = ConvertTo-SecureString -String "$env:SIGNING_PWD" -Force -AsPlainText
             $cert = Get-PfxCertificate -FilePath "${{ github.workspace }}\SigningCertificate.pfx" -Password $password
             Export-Certificate -Cert $cert -FilePath "TermiusCN-Tool.cer"
             Write-Host "Public certificate exported successfully"
          }

      - name: Clean up certificate
        if: always()
        run: |
          if (Test-Path "${{ github.workspace }}\SigningCertificate.pfx") {
            Remove-Item "${{ github.workspace }}\SigningCertificate.pfx" -Force
            Write-Host "Certificate deleted."
          }

      - name: Find and Copy MSIX files
        if: ${{ inputs.build_msix }}
        run: |
          Write-Host "Searching for MSIX files..."
          Get-ChildItem -Path "." -Filter "*.msix" -Recurse | ForEach-Object { Write-Host $_.FullName }
          
          $msixX64 = Get-ChildItem -Path "." -Filter "*.msix" -Recurse | Where-Object { $_.FullName -like "*x64*" -and $_.FullName -notlike "*ARM64*" } | Select-Object -First 1
          $msixArm64 = Get-ChildItem -Path "." -Filter "*.msix" -Recurse | Where-Object { $_.FullName -like "*ARM64*" } | Select-Object -First 1
          
          if ($msixX64) {
            Copy-Item $msixX64.FullName -Destination "TermiusCN-Tool-x64.msix"
            Write-Host "Copied x64 MSIX: $($msixX64.FullName)"
          }
          
          if ($msixArm64) {
            Copy-Item $msixArm64.FullName -Destination "TermiusCN-Tool-arm64.msix"
            Write-Host "Copied ARM64 MSIX: $($msixArm64.FullName)"
          }

      - name: List output files
        run: |
          Write-Host "=== Build Artifacts ==="
          Get-ChildItem -Path "." -Filter "TermiusCN-Tool*" -File | ForEach-Object { 
             Write-Host "$($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
          }

      # ========== 上传构建产物 ==========
      - name: Upload Portable x64
        if: ${{ inputs.build_portable }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-Portable-x64
          path: TermiusCN-Tool-Portable-x64.zip
          retention-days: 7

      - name: Upload Portable ARM64
        if: ${{ inputs.build_portable }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-Portable-arm64
          path: TermiusCN-Tool-Portable-arm64.zip
          retention-days: 7

      - name: Upload MSIX x64
        if: ${{ inputs.build_msix }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-MSIX-x64
          path: TermiusCN-Tool-x64.msix
          retention-days: 7

      - name: Upload MSIX ARM64
        if: ${{ inputs.build_msix }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-MSIX-arm64
          path: TermiusCN-Tool-arm64.msix
          retention-days: 7

      - name: Upload Certificate
        if: ${{ inputs.build_msix }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-Certificate
          path: TermiusCN-Tool.cer
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Install Script
        if: ${{ inputs.build_msix }}
        uses: actions/upload-artifact@v4
        with:
          name: Install-Script
          path: Install-App.ps1
          retention-days: 7
