name: Manual Build

on:
  workflow_dispatch:
    inputs:
      build_portable:
        description: '构建便携版'
        type: boolean
        default: true
      build_msix:
        description: '构建 MSIX 安装包'
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # ========== 便携版 (Portable) ==========
      - name: Build Portable x64
        if: ${{ inputs.build_portable }}
        run: dotnet publish TermiusCN-Tool.csproj -c Release -r win-x64 -p:Platform=x64 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true --self-contained true -o publish/portable-x64

      - name: Build Portable ARM64
        if: ${{ inputs.build_portable }}
        run: dotnet publish TermiusCN-Tool.csproj -c Release -r win-arm64 -p:Platform=ARM64 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true --self-contained true -o publish/portable-arm64

      - name: Create Portable x64 Archive
        if: ${{ inputs.build_portable }}
        run: Compress-Archive -Path publish/portable-x64/* -DestinationPath TermiusCN-Tool-Portable-x64.zip

      - name: Create Portable ARM64 Archive
        if: ${{ inputs.build_portable }}
        run: Compress-Archive -Path publish/portable-arm64/* -DestinationPath TermiusCN-Tool-Portable-arm64.zip

      # ========== MSIX 安装包 ==========
      - name: Decode signing certificate
        if: ${{ inputs.build_msix }}
        env:
          # 对应 Secret: SIGNING_CERTIFICATE
          SIGNING_CERT_BASE64: ${{ secrets.SIGNING_CERTIFICATE }}
        run: |
          if ("$env:SIGNING_CERT_BASE64" -ne "") {
            $certBytes = [Convert]::FromBase64String("$env:SIGNING_CERT_BASE64")
            [IO.File]::WriteAllBytes("${{ github.workspace }}\SigningCertificate.pfx", $certBytes)
            Write-Host "Certificate decoded successfully to ${{ github.workspace }}\SigningCertificate.pfx"
          } else {
            Write-Host "No signing certificate configured (Secret SIGNING_CERTIFICATE is empty)."
          }

      - name: Build MSIX x64
        if: ${{ inputs.build_msix }}
        env:
          # 对应 Secret: SIGNING_CERTIFICATE_PASSWORD
          SIGNING_PWD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          $pfxPath = "${{ github.workspace }}\SigningCertificate.pfx"
          if (Test-Path $pfxPath) {
            Write-Host "Building SIGNED MSIX for x64..."
            # 直接调用 msbuild，避免 Invoke-Expression 的转义问题
            msbuild TermiusCN-Tool.csproj /restore `
              /p:Configuration=Release /p:Platform=x64 /p:RuntimeIdentifier=win-x64 `
              /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=true `
              /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly `
              /p:AppxPackageDir="AppPackages\" `
              /p:PackageCertificateKeyFile="$pfxPath" `
              /p:PackageCertificatePassword="$env:SIGNING_PWD"
          } else {
            Write-Host "Certificate not found. Building unsigned MSIX for x64..."
            msbuild TermiusCN-Tool.csproj /restore `
              /p:Configuration=Release /p:Platform=x64 /p:RuntimeIdentifier=win-x64 `
              /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=false `
              /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly `
              /p:AppxPackageDir="AppPackages\"
          }

      - name: Build MSIX ARM64
        if: ${{ inputs.build_msix }}
        env:
          # 对应 Secret: SIGNING_CERTIFICATE_PASSWORD
          SIGNING_PWD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          $pfxPath = "${{ github.workspace }}\SigningCertificate.pfx"
          if (Test-Path $pfxPath) {
            Write-Host "Building SIGNED MSIX for ARM64..."
            msbuild TermiusCN-Tool.csproj /restore `
              /p:Configuration=Release /p:Platform=ARM64 /p:RuntimeIdentifier=win-arm64 `
              /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=true `
              /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly `
              /p:AppxPackageDir="AppPackages\" `
              /p:PackageCertificateKeyFile="$pfxPath" `
              /p:PackageCertificatePassword="$env:SIGNING_PWD"
          } else {
            Write-Host "Certificate not found. Building unsigned MSIX for ARM64..."
            msbuild TermiusCN-Tool.csproj /restore `
              /p:Configuration=Release /p:Platform=ARM64 /p:RuntimeIdentifier=win-arm64 `
              /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=false `
              /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly `
              /p:AppxPackageDir="AppPackages\"
          }

      - name: Export public certificate (.cer)
        if: ${{ inputs.build_msix }}
        env:
          SIGNING_CERT_BASE64: ${{ secrets.SIGNING_CERTIFICATE }}
          SIGNING_PWD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          if ("$env:SIGNING_CERT_BASE64" -ne "") {
            if (Test-Path "${{ github.workspace }}\SigningCertificate.pfx") {
               $password = ConvertTo-SecureString -String "$env:SIGNING_PWD" -Force -AsPlainText
               $cert = Get-PfxCertificate -FilePath "${{ github.workspace }}\SigningCertificate.pfx" -Password $password
               Export-Certificate -Cert $cert -FilePath "TermiusCN-Tool.cer"
               Write-Host "Public certificate exported successfully"
            }
          }

      - name: Clean up certificate
        if: always()
        run: |
          if (Test-Path "${{ github.workspace }}\SigningCertificate.pfx") {
            Remove-Item "${{ github.workspace }}\SigningCertificate.pfx" -Force
            Write-Host "Certificate deleted."
          }

      - name: Find and Copy MSIX files
        if: ${{ inputs.build_msix }}
        run: |
          Write-Host "Searching for MSIX files..."
          Get-ChildItem -Path "." -Filter "*.msix" -Recurse | ForEach-Object { Write-Host $_.FullName }
          
          $msixX64 = Get-ChildItem -Path "." -Filter "*.msix" -Recurse | Where-Object { $_.FullName -like "*x64*" -and $_.FullName -notlike "*ARM64*" } | Select-Object -First 1
          $msixArm64 = Get-ChildItem -Path "." -Filter "*.msix" -Recurse | Where-Object { $_.FullName -like "*ARM64*" } | Select-Object -First 1
          
          if ($msixX64) {
            Copy-Item $msixX64.FullName -Destination "TermiusCN-Tool-x64.msix"
            Write-Host "Copied x64 MSIX: $($msixX64.FullName)"
          }
          
          if ($msixArm64) {
            Copy-Item $msixArm64.FullName -Destination "TermiusCN-Tool-arm64.msix"
            Write-Host "Copied ARM64 MSIX: $($msixArm64.FullName)"
          }

      - name: List output files
        run: |
          Write-Host "=== Build Artifacts ==="
          Get-ChildItem -Path "." -Filter "TermiusCN-Tool*" -File | ForEach-Object { 
             Write-Host "$($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
          }

      # ========== 上传构建产物 ==========
      - name: Upload Portable x64
        if: ${{ inputs.build_portable }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-Portable-x64
          path: TermiusCN-Tool-Portable-x64.zip
          retention-days: 7

      - name: Upload Portable ARM64
        if: ${{ inputs.build_portable }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-Portable-arm64
          path: TermiusCN-Tool-Portable-arm64.zip
          retention-days: 7

      - name: Upload MSIX x64
        if: ${{ inputs.build_msix }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-MSIX-x64
          path: TermiusCN-Tool-x64.msix
          retention-days: 7

      - name: Upload MSIX ARM64
        if: ${{ inputs.build_msix }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-MSIX-arm64
          path: TermiusCN-Tool-arm64.msix
          retention-days: 7

      - name: Upload Certificate
        if: ${{ inputs.build_msix }}
        uses: actions/upload-artifact@v4
        with:
          name: TermiusCN-Tool-Certificate
          path: TermiusCN-Tool.cer
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Install Script
        if: ${{ inputs.build_msix }}
        uses: actions/upload-artifact@v4
        with:
          name: Install-Script
          path: Install-App.ps1
          retention-days: 7
