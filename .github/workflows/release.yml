name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Get version from tag
        id: version
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          # ç¡®ä¿ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡® (x.x.x.x)
          $parts = $version.Split('.')
          while ($parts.Count -lt 4) {
            $parts += "0"
          }
          $fullVersion = $parts[0..3] -join '.'
          echo "VERSION=$fullVersion" >> $env:GITHUB_OUTPUT
          echo "Version: $fullVersion"

      - name: Update Package.appxmanifest version
        run: |
          $manifest = Get-Content "Package.appxmanifest" -Raw
          $manifest = $manifest -creplace 'Version="[\d\.]+"', 'Version="${{ steps.version.outputs.VERSION }}"'
          Set-Content "Package.appxmanifest" $manifest
          Write-Host "Updated manifest version to ${{ steps.version.outputs.VERSION }}"

      # ========== ä¾¿æºç‰ˆ (Portable) ==========
      - name: Build Portable x64
        run: dotnet publish TermiusCN-Tool.csproj -c Release -r win-x64 -p:Platform=x64 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true --self-contained true -o publish/portable-x64

      - name: Build Portable ARM64
        run: dotnet publish TermiusCN-Tool.csproj -c Release -r win-arm64 -p:Platform=ARM64 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true --self-contained true -o publish/portable-arm64

      - name: Create Portable x64 Archive
        run: Compress-Archive -Path publish/portable-x64/* -DestinationPath TermiusCN-Tool-${{ github.ref_name }}-Portable-x64.zip

      - name: Create Portable ARM64 Archive
        run: Compress-Archive -Path publish/portable-arm64/* -DestinationPath TermiusCN-Tool-${{ github.ref_name }}-Portable-arm64.zip

      # ========== MSIX å®‰è£…åŒ… ==========
      - name: Decode signing certificate
        if: ${{ secrets.SIGNING_CERTIFICATE != '' }}
        run: |
          $certBytes = [Convert]::FromBase64String("${{ secrets.SIGNING_CERTIFICATE }}")
          [IO.File]::WriteAllBytes("${{ github.workspace }}\SigningCertificate.pfx", $certBytes)
          Write-Host "Certificate decoded successfully"

      - name: Build MSIX x64
        run: |
          $signingEnabled = if ("${{ secrets.SIGNING_CERTIFICATE }}" -ne "") { "true" } else { "false" }
          $certFile = if ($signingEnabled -eq "true") { "/p:PackageCertificateKeyFile=${{ github.workspace }}\SigningCertificate.pfx /p:PackageCertificatePassword=${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}" } else { "" }
          $cmd = "msbuild TermiusCN-Tool.csproj /restore /p:Configuration=Release /p:Platform=x64 /p:RuntimeIdentifier=win-x64 /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=$signingEnabled /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxPackageDir=AppPackages\ $certFile"
          Write-Host "Running: $cmd"
          Invoke-Expression $cmd

      - name: Build MSIX ARM64
        run: |
          $signingEnabled = if ("${{ secrets.SIGNING_CERTIFICATE }}" -ne "") { "true" } else { "false" }
          $certFile = if ($signingEnabled -eq "true") { "/p:PackageCertificateKeyFile=${{ github.workspace }}\SigningCertificate.pfx /p:PackageCertificatePassword=${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}" } else { "" }
          $cmd = "msbuild TermiusCN-Tool.csproj /restore /p:Configuration=Release /p:Platform=ARM64 /p:RuntimeIdentifier=win-arm64 /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=$signingEnabled /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxPackageDir=AppPackages\ $certFile"
          Write-Host "Running: $cmd"
          Invoke-Expression $cmd

      - name: Export public certificate (.cer)
        if: ${{ secrets.SIGNING_CERTIFICATE != '' }}
        run: |
          $password = ConvertTo-SecureString -String "${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}" -Force -AsPlainText
          $cert = Get-PfxCertificate -FilePath "${{ github.workspace }}\SigningCertificate.pfx" -Password $password
          Export-Certificate -Cert $cert -FilePath "TermiusCN-Tool.cer"
          Write-Host "Public certificate exported"

      - name: Clean up certificate
        if: always()
        run: |
          if (Test-Path "${{ github.workspace }}\SigningCertificate.pfx") {
            Remove-Item "${{ github.workspace }}\SigningCertificate.pfx" -Force
          }

      - name: Find and Copy MSIX files
        run: |
          Write-Host "Searching for MSIX files..."
          Get-ChildItem -Path "." -Filter "*.msix" -Recurse | ForEach-Object { Write-Host $_.FullName }
          
          $msixX64 = Get-ChildItem -Path "." -Filter "*.msix" -Recurse | Where-Object { $_.FullName -like "*x64*" -and $_.FullName -notlike "*ARM64*" } | Select-Object -First 1
          $msixArm64 = Get-ChildItem -Path "." -Filter "*.msix" -Recurse | Where-Object { $_.FullName -like "*ARM64*" } | Select-Object -First 1
          
          if ($msixX64) {
            Copy-Item $msixX64.FullName -Destination "TermiusCN-Tool-${{ github.ref_name }}-x64.msix"
            Write-Host "Copied x64 MSIX: $($msixX64.FullName)"
          } else {
            Write-Host "::warning::x64 MSIX not found"
          }
          
          if ($msixArm64) {
            Copy-Item $msixArm64.FullName -Destination "TermiusCN-Tool-${{ github.ref_name }}-arm64.msix"
            Write-Host "Copied ARM64 MSIX: $($msixArm64.FullName)"
          } else {
            Write-Host "::warning::ARM64 MSIX not found"
          }

      - name: List output files
        run: |
          Write-Host "=== Release files ==="
          Get-ChildItem -Path "." -Filter "TermiusCN-Tool-*" | ForEach-Object { 
            Write-Host "$($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
          }

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            TermiusCN-Tool-${{ github.ref_name }}-Portable-x64.zip
            TermiusCN-Tool-${{ github.ref_name }}-Portable-arm64.zip
            TermiusCN-Tool-${{ github.ref_name }}-x64.msix
            TermiusCN-Tool-${{ github.ref_name }}-arm64.msix
            TermiusCN-Tool.cer
            Install-App.ps1
          generate_release_notes: true
          fail_on_unmatched_files: false
          body: |
            ## ä¸‹è½½è¯´æ˜
            
            ### ğŸ“¦ MSIX å®‰è£…åŒ…ï¼ˆæ¨èï¼‰
            - `TermiusCN-Tool-${{ github.ref_name }}-x64.msix` - 64ä½ Windows å®‰è£…åŒ…
            - `TermiusCN-Tool-${{ github.ref_name }}-arm64.msix` - ARM64 Windows å®‰è£…åŒ…
            
            #### å®‰è£…æ–¹æ³•
            **æ–¹æ³•ä¸€ï¼šä½¿ç”¨å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰**
            1. ä¸‹è½½ `TermiusCN-Tool-${{ github.ref_name }}-x64.msix`ã€`TermiusCN-Tool.cer` å’Œ `Install-App.ps1`
            2. å°†ä¸‰ä¸ªæ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
            3. å³é”® `Install-App.ps1` â†’ ä½¿ç”¨ PowerShell è¿è¡Œï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
            
            **æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å®‰è£…**
            1. åŒå‡» `TermiusCN-Tool.cer` â†’ å®‰è£…è¯ä¹¦ â†’ æœ¬åœ°è®¡ç®—æœº â†’ å—ä¿¡ä»»çš„äºº
            2. åŒå‡» `.msix` æ–‡ä»¶å®‰è£…
            
            **æ–¹æ³•ä¸‰ï¼šå¼€å‘è€…æ¨¡å¼**
            1. æ‰“å¼€ã€Œè®¾ç½® â†’ ç³»ç»Ÿ â†’ å¼€å‘è€…é€‰é¡¹ã€â†’ å¯ç”¨ã€Œå¼€å‘äººå‘˜æ¨¡å¼ã€
            2. åŒå‡» `.msix` æ–‡ä»¶å®‰è£…
            
            ### ğŸ“‚ ä¾¿æºç‰ˆï¼ˆè§£å‹å³ç”¨ï¼‰
            - `TermiusCN-Tool-${{ github.ref_name }}-Portable-x64.zip` - 64ä½ Windows ä¾¿æºç‰ˆ
            - `TermiusCN-Tool-${{ github.ref_name }}-Portable-arm64.zip` - ARM64 Windows ä¾¿æºç‰ˆ
            
            > è§£å‹åè¿è¡Œ `TermiusCN-Tool.exe` å³å¯ä½¿ç”¨ï¼Œæ— éœ€å®‰è£…
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
