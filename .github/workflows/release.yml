name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # æå–ç‰ˆæœ¬å·
      - name: Get version from tag
        id: version
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          # ç¡®ä¿ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡® (x.x.x.x)
          $parts = $version.Split('.')
          while ($parts.Count -lt 4) {
            $parts += "0"
          }
          $fullVersion = $parts[0..3] -join '.'
          echo "VERSION=$fullVersion" >> $env:GITHUB_OUTPUT
          echo "Version: $fullVersion"

      - name: Update Package.appxmanifest version
        run: |
          $manifest = Get-Content "Package.appxmanifest" -Raw
          $manifest = $manifest -creplace 'Version="[\d\.]+"', 'Version="${{ steps.version.outputs.VERSION }}"'
          Set-Content "Package.appxmanifest" $manifest
          Write-Host "Updated manifest version to ${{ steps.version.outputs.VERSION }}"

      # ========== ä¾¿æºç‰ˆ (Portable) ==========
      - name: Build Portable x64
        run: dotnet publish TermiusCN-Tool.csproj -c Release -r win-x64 -p:Platform=x64 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true --self-contained true -o publish/portable-x64

      - name: Build Portable ARM64
        run: dotnet publish TermiusCN-Tool.csproj -c Release -r win-arm64 -p:Platform=ARM64 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true --self-contained true -o publish/portable-arm64

      - name: Create Portable x64 Archive
        run: Compress-Archive -Path publish/portable-x64/* -DestinationPath TermiusCN-Tool-${{ github.ref_name }}-Portable-x64.zip

      - name: Create Portable ARM64 Archive
        run: Compress-Archive -Path publish/portable-arm64/* -DestinationPath TermiusCN-Tool-${{ github.ref_name }}-Portable-arm64.zip

      # ========== MSIX å®‰è£…åŒ… ==========
      
      # 1. å‡†å¤‡è¯ä¹¦ï¼šè§£ç å¹¶å¯¼å…¥åˆ°å½“å‰ç”¨æˆ·å­˜å‚¨åŒº (User Store)
      # è¿™èƒ½è§£å†³ MSBuild æ— æ³•ç›´æ¥è¯»å–å¸¦å¯†ç  PFX æ–‡ä»¶çš„é—®é¢˜ (APPX0105)
      - name: Setup Signing Certificate
        if: ${{ secrets.SIGNING_CERTIFICATE != '' }}
        env:
          SIGNING_CERT_BASE64: ${{ secrets.SIGNING_CERTIFICATE }}
          SIGNING_PWD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        shell: pwsh
        run: |
          $pfxPath = "${{ github.workspace }}\SigningCertificate.pfx"
          
          # è§£ç 
          try {
            $certBytes = [Convert]::FromBase64String("$env:SIGNING_CERT_BASE64")
            [IO.File]::WriteAllBytes($pfxPath, $certBytes)
          } catch {
            Write-Error "Certificate decoding failed."
            exit 1
          }

          # å¯¼å…¥åˆ°å­˜å‚¨åŒº
          Write-Host "Importing certificate to CurrentUser\My..."
          $password = ConvertTo-SecureString -String "$env:SIGNING_PWD" -Force -AsPlainText
          try {
            $cert = Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $password
            $thumbprint = $cert.Thumbprint
            Write-Host "Success! Thumbprint: $thumbprint"
            
            # å°†æŒ‡çº¹ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "SIGNING_CERT_THUMBPRINT=$thumbprint" >> $env:GITHUB_ENV
          } catch {
            Write-Error "Failed to import certificate to store."
            exit 1
          }

      # 2. æ„å»º MSIX x64
      - name: Build MSIX x64
        shell: pwsh
        run: |
          $thumbprint = "$env:SIGNING_CERT_THUMBPRINT"
          
          if (-not [string]::IsNullOrWhiteSpace($thumbprint)) {
            Write-Host "Building SIGNED MSIX (x64)..."
            # å…³é”®ï¼šæŒ‡å®š Thumbprintï¼Œå¹¶å°† KeyFile è®¾ä¸ºç©ºï¼Œå¼ºåˆ¶ä½¿ç”¨å­˜å‚¨åŒºæ¨¡å¼
            msbuild TermiusCN-Tool.csproj /restore /p:Configuration=Release /p:Platform=x64 /p:RuntimeIdentifier=win-x64 `
              /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=true `
              /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxPackageDir=AppPackages\ `
              /p:PackageCertificateThumbprint="$thumbprint" /p:PackageCertificateKeyFile="" /p:PackageCertificatePassword=""
          } else {
            Write-Host "Building UNSIGNED MSIX (x64)..."
            msbuild TermiusCN-Tool.csproj /restore /p:Configuration=Release /p:Platform=x64 /p:RuntimeIdentifier=win-x64 `
              /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=false `
              /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxPackageDir=AppPackages\
          }

      # 3. æ„å»º MSIX ARM64
      - name: Build MSIX ARM64
        shell: pwsh
        run: |
          $thumbprint = "$env:SIGNING_CERT_THUMBPRINT"
          
          if (-not [string]::IsNullOrWhiteSpace($thumbprint)) {
            Write-Host "Building SIGNED MSIX (ARM64)..."
            msbuild TermiusCN-Tool.csproj /restore /p:Configuration=Release /p:Platform=ARM64 /p:RuntimeIdentifier=win-arm64 `
              /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=true `
              /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxPackageDir=AppPackages\ `
              /p:PackageCertificateThumbprint="$thumbprint" /p:PackageCertificateKeyFile="" /p:PackageCertificatePassword=""
          } else {
            Write-Host "Building UNSIGNED MSIX (ARM64)..."
            msbuild TermiusCN-Tool.csproj /restore /p:Configuration=Release /p:Platform=ARM64 /p:RuntimeIdentifier=win-arm64 `
              /p:GenerateAppxPackageOnBuild=true /p:AppxPackageSigningEnabled=false `
              /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxPackageDir=AppPackages\
          }

      # 4. å¯¼å‡ºå…¬é’¥è¯ä¹¦ (ä¾›ç”¨æˆ·å®‰è£…)
      - name: Export public certificate (.cer)
        if: ${{ secrets.SIGNING_CERTIFICATE != '' }}
        env:
          SIGNING_PWD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          if (Test-Path "${{ github.workspace }}\SigningCertificate.pfx") {
            $password = ConvertTo-SecureString -String "$env:SIGNING_PWD" -Force -AsPlainText
            $cert = Get-PfxCertificate -FilePath "${{ github.workspace }}\SigningCertificate.pfx" -Password $password
            Export-Certificate -Cert $cert -FilePath "TermiusCN-Tool.cer"
            Write-Host "Public certificate exported."
          }

      - name: Clean up certificate
        if: always()
        run: |
          if (Test-Path "${{ github.workspace }}\SigningCertificate.pfx") {
            Remove-Item "${{ github.workspace }}\SigningCertificate.pfx" -Force
          }

      - name: Find and Copy MSIX files
        run: |
          Write-Host "Searching for MSIX files..."
          
          $msixX64 = Get-ChildItem -Path "." -Filter "*.msix" -Recurse | Where-Object { $_.FullName -like "*x64*" -and $_.FullName -notlike "*ARM64*" } | Select-Object -First 1
          $msixArm64 = Get-ChildItem -Path "." -Filter "*.msix" -Recurse | Where-Object { $_.FullName -like "*ARM64*" } | Select-Object -First 1
          
          if ($msixX64) {
            Copy-Item $msixX64.FullName -Destination "TermiusCN-Tool-${{ github.ref_name }}-x64.msix"
            Write-Host "Copied x64 MSIX: $($msixX64.FullName)"
          } else { Write-Host "::warning::x64 MSIX not found" }
          
          if ($msixArm64) {
            Copy-Item $msixArm64.FullName -Destination "TermiusCN-Tool-${{ github.ref_name }}-arm64.msix"
            Write-Host "Copied ARM64 MSIX: $($msixArm64.FullName)"
          } else { Write-Host "::warning::ARM64 MSIX not found" }

      - name: Create Installer Bundle (x64)
        run: |
          $bundleName = "TermiusCN-Tool-${{ github.ref_name }}-Installer-x64.zip"
          $msixName = "TermiusCN-Tool-${{ github.ref_name }}-x64.msix"
          
          if (Test-Path $msixName) {
            # Create a temporary directory for bundling
            New-Item -ItemType Directory -Force -Path "InstallerBundle"
            
            # Copy files to the bundle directory
            Copy-Item $msixName -Destination "InstallerBundle\"
            if (Test-Path "TermiusCN-Tool.cer") { Copy-Item "TermiusCN-Tool.cer" -Destination "InstallerBundle\" }
            if (Test-Path "Install-App.ps1") { Copy-Item "Install-App.ps1" -Destination "InstallerBundle\" }
            
            # Create the zip archive
            Compress-Archive -Path "InstallerBundle\*" -DestinationPath $bundleName
            Write-Host "Created Installer Bundle: $bundleName"
            
            # Clean up
            Remove-Item "InstallerBundle" -Recurse -Force
          } else {
            Write-Host "::warning::Skipping Installer Bundle creation (x64 MSIX not found)"
          }

      - name: List output files
        run: |
          Write-Host "=== Release files ==="
          Get-ChildItem -Path "." -Filter "TermiusCN-Tool-*" | ForEach-Object { 
            Write-Host "$($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
          }

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            TermiusCN-Tool-${{ github.ref_name }}-Portable-x64.zip
            TermiusCN-Tool-${{ github.ref_name }}-Portable-arm64.zip
            TermiusCN-Tool-${{ github.ref_name }}-x64.msix
            TermiusCN-Tool-${{ github.ref_name }}-arm64.msix
            TermiusCN-Tool-${{ github.ref_name }}-Installer-x64.zip
            TermiusCN-Tool.cer
            Install-App.ps1
          generate_release_notes: true
          fail_on_unmatched_files: false
          body: |
            ## ä¸‹è½½è¯´æ˜
            
            ### ğŸ“¦ MSIX å®‰è£…åŒ…ï¼ˆæ¨èï¼‰
            - `TermiusCN-Tool-${{ github.ref_name }}-x64.msix` - 64ä½ Windows å®‰è£…åŒ…
            - `TermiusCN-Tool-${{ github.ref_name }}-arm64.msix` - ARM64 Windows å®‰è£…åŒ…
            
            #### å®‰è£…æ–¹æ³•
            **æ–¹æ³•ä¸€ï¼šä½¿ç”¨å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰**
            1. ä¸‹è½½ `TermiusCN-Tool-${{ github.ref_name }}-Installer-x64.zip`
            2. è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°åŒä¸€ç›®å½•
            3. å³é”® `Install-App.ps1` â†’ ä½¿ç”¨ PowerShell è¿è¡Œï¼ˆä¼šè‡ªåŠ¨ææƒå¹¶å®‰è£…è¯ä¹¦ï¼‰
            
            **æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å®‰è£…**
            1. åŒå‡» `TermiusCN-Tool.cer` â†’ å®‰è£…è¯ä¹¦ â†’ æœ¬åœ°è®¡ç®—æœº â†’ **å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„**
            2. åŒå‡» `.msix` æ–‡ä»¶å®‰è£…
            
            **æ–¹æ³•ä¸‰ï¼šå¼€å‘è€…æ¨¡å¼**
            1. æ‰“å¼€ã€Œè®¾ç½® â†’ ç³»ç»Ÿ â†’ å¼€å‘è€…é€‰é¡¹ã€â†’ å¯ç”¨ã€Œå¼€å‘äººå‘˜æ¨¡å¼ã€
            2. åŒå‡» `.msix` æ–‡ä»¶å®‰è£…
            
            ### ğŸ“‚ ä¾¿æºç‰ˆï¼ˆè§£å‹å³ç”¨ï¼‰
            - `TermiusCN-Tool-${{ github.ref_name }}-Portable-x64.zip` - 64ä½ Windows ä¾¿æºç‰ˆ
            - `TermiusCN-Tool-${{ github.ref_name }}-Portable-arm64.zip` - ARM64 Windows ä¾¿æºç‰ˆ
            
            > è§£å‹åè¿è¡Œ `TermiusCN-Tool.exe` å³å¯ä½¿ç”¨ï¼Œæ— éœ€å®‰è£…
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
