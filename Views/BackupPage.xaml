<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="TermiusCN_Tool.Views.BackupPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:TermiusCN_Tool.Models"
    xmlns:converters="using:TermiusCN_Tool.Converters"
    mc:Ignorable="d">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 顶部标题和操作栏 -->
        <StackPanel Grid.Row="0" Spacing="16">
            <TextBlock Text="备份管理" Style="{StaticResource TitleTextBlockStyle}"/>

            <CommandBar DefaultLabelPosition="Right" Background="Transparent">
                <AppBarButton Icon="Refresh" Label="刷新"
                             Command="{x:Bind ViewModel.LoadBackupsCommand}"/>
                <AppBarButton Icon="Undo" Label="还原"
                             Command="{x:Bind ViewModel.RestoreCommand}"
                             IsEnabled="{x:Bind ViewModel.SelectedBackup, Mode=OneWay, Converter={StaticResource NullToBoolConverter}}"/>
                <AppBarButton Icon="Delete" Label="删除"
                             Command="{x:Bind ViewModel.DeleteCommand}"
                             IsEnabled="{x:Bind ViewModel.SelectedBackup, Mode=OneWay, Converter={StaticResource NullToBoolConverter}}"/>
                <AppBarSeparator/>
                <AppBarButton Icon="Folder" Label="打开文件夹"
                             Command="{x:Bind ViewModel.OpenBackupFolderCommand}"/>
            </CommandBar>
        </StackPanel>

        <!-- 备份列表 -->
        <Grid Grid.Row="1" Margin="0,16,0,0">
            <!-- 加载中 -->
            <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                         Width="60" Height="60"
                         Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

            <!-- 空状态 - 仅在不加载且没有备份时显示 -->
            <StackPanel x:Name="EmptyStatePanel" HorizontalAlignment="Center" VerticalAlignment="Center"
                       Spacing="16">
                <FontIcon Glyph="&#xE7C3;" FontSize="64"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                <TextBlock Text="暂无备份"
                          Style="{StaticResource SubtitleTextBlockStyle}"
                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                <TextBlock Text="执行汉化操作时会自动创建备份"
                          Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                          HorizontalAlignment="Center"/>
            </StackPanel>

            <!-- 备份列表 -->
            <ListView ItemsSource="{x:Bind ViewModel.Backups, Mode=OneWay}"
                     SelectedItem="{x:Bind ViewModel.SelectedBackup, Mode=TwoWay}"
                     SelectionMode="Single"
                     Visibility="{x:Bind ViewModel.HasBackups, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:BackupInfo">
                        <Grid Padding="12" ColumnSpacing="16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- 图标 -->
                            <FontIcon Grid.Column="0" Glyph="&#xE8B7;"
                                     FontSize="32"
                                     Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>

                            <!-- 信息 -->
                            <StackPanel Grid.Column="1" Spacing="4">
                                <TextBlock Text="{x:Bind BackupTimeDisplay}"
                                          FontWeight="SemiBold"/>
                                <TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                    <Run Text="版本:"/>
                                    <Run Text="{x:Bind Version}"/>
                                </TextBlock>
                                <TextBlock Text="{x:Bind FileSizeDisplay}"
                                          FontSize="12"
                                          Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>
    </Grid>

    <Page.Resources>
        <!-- Null 转 Bool 转换器 -->
        <converters:NullToBoolConverter x:Key="NullToBoolConverter"/>
        <!-- Bool 转 Visibility 转换器 -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <!-- Bool 反转转 Visibility 转换器 -->
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
    </Page.Resources>
</Page>
